#!/usr/bin/env python3
import os
import subprocess
import sys
from typing import Any, Dict

from fastmcp import FastMCP


# Create FastMCP server
mcp = FastMCP("Odoo MCP Server")


@mcp.tool()
def create_contact(
    name: str,
    email: str = None,
    phone: str = None,
    mobile: str = None,
    street: str = None,
    city: str = None,
    zip: str = None,
    country_id: int = None,
    is_company: bool = None
) -> str:
    """Create a new contact (res.partner) in Odoo.

    Args:
        name: The name of the contact (required)
        email: The email address of the contact
        phone: The phone number of the contact
        mobile: The mobile phone number of the contact
        street: The street address
        city: The city
        zip: The postal/zip code
        country_id: The country ID
        is_company: Whether this contact is a company

    Returns:
        Success or error message
    """
    try:
        # Build the contact data dictionary
        contact_data = {"name": name}

        # Add optional fields if provided
        optional_fields = {
            "email": email,
            "phone": phone,
            "mobile": mobile,
            "street": street,
            "city": city,
            "zip": zip,
            "country_id": country_id,
            "is_company": is_company
        }

        for field, value in optional_fields.items():
            if value is not None:
                contact_data[field] = value

        # Force the correct project root and build absolute path to odoocli
        project_root = "/home/janikvonrotz/Odoo-Build"
        odoocli_path = os.path.join(project_root, "images", "odoocli", "bin", "odoocli")

        # Use the same Python interpreter that's running this script
        python_executable = sys.executable

        # Build the odoocli command
        cmd = [
            python_executable,
            odoocli_path,
            "--method", "create",
            "--model", "res.partner",
            "--value", value_str
        ]

        # Debug: print the command being executed
        print(f"Executing command: {' '.join(cmd)}", file=sys.stderr)

        # Execute the command
        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            check=True
        )

        return f"Successfully created contact '{name}'"

    except subprocess.CalledProcessError as e:
        error_msg = e.stderr.strip() if e.stderr else str(e)
        return f"Error executing odoocli: {error_msg}"
    except Exception as e:
        return f"Unexpected error: {str(e)}"


if __name__ == "__main__":
    mcp.run()

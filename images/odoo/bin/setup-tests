#!/usr/bin/env bash
set -e

log-entrypoint 'Install python packages required for testing.'
uv pip install --no-cache-dir coverage websocket-client

log-entrypoint "Collect requirements.txt files in $TEST_ADDONS_DIR."
find "$TEST_ADDONS_DIR" -type f -name "requirements.txt" -exec uv pip install -r {} \;

log-entrypoint "Collect test-requirements.txt files in $TEST_ADDONS_DIR."
find "$TEST_ADDONS_DIR" -type f -name "test-requirements.txt" -exec uv pip install -r {} \;

if [[ -n "$TEST_INCLUDE" ]]; then
    test_depends_modules=$(manifestoo --select-include "$TEST_INCLUDE" --select-exclude "$TEST_EXCLUDE" list-depends --separator=,)
else
    test_depends_modules=$(manifestoo --select-addons-dir "$TEST_ADDONS_DIR" --select-exclude "$TEST_EXCLUDE" list-depends --separator=,)
fi

log-entrypoint "Install depends modules for testing: $test_depends_modules"
unbuffer /opt/odoo-venv/bin/odoo \
    -d "$ODOO_DATABASE" \
    -i "${test_depends_modules:-base}" \
    --load-language=en_US \
    --stop-after-init \
    --http-port=8068
